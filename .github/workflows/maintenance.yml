name: Maintenance & Monitoring

on:
  workflow_dispatch:

jobs:
  dependency-updates:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Check for Python dependency updates
      run: |
        cd backend
        pip install pip-check-updates
        pip list --outdated
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Check for Node.js dependency updates
      run: |
        cd frontend
        npm outdated || true
    
    - name: Create dependency update issue
      uses: actions/github-script@v7
      with:
        script: |
          const { execSync } = require('child_process');
          
          try {
            const pythonOutdated = execSync('cd backend && pip list --outdated', { encoding: 'utf8' });
            const nodeOutdated = execSync('cd frontend && npm outdated || true', { encoding: 'utf8' });
            
            if (pythonOutdated.trim() || nodeOutdated.trim()) {
              const body = `## Dependency Updates Available\n\n### Python Dependencies\n\`\`\`\n${pythonOutdated}\n\`\`\`\n\n### Node.js Dependencies\n\`\`\`\n${nodeOutdated}\n\`\`\``;
              
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Dependency Updates Available - ' + new Date().toISOString().split('T')[0],
                body: body,
                labels: ['maintenance', 'dependencies']
              });
            }
          } catch (error) {
            console.log('No outdated dependencies found or error occurred:', error.message);
          }

  security-audit:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run security audit
      run: |
        # Python security check
        cd backend
        pip install safety bandit
        safety check -r requirements.txt --json > ../security-python.json || true
        bandit -r . -f json -o ../security-bandit.json || true
        
        # Node.js security check
        cd ../frontend
        npm audit --json > ../security-npm.json || true
    
    - name: Create security report issue
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          let securityIssues = [];
          
          try {
            const pythonSafety = JSON.parse(fs.readFileSync('security-python.json', 'utf8'));
            if (pythonSafety.vulnerabilities && pythonSafety.vulnerabilities.length > 0) {
              securityIssues.push(`**Python Safety Issues:** ${pythonSafety.vulnerabilities.length} vulnerabilities found`);
            }
          } catch (e) {}
          
          try {
            const banditReport = JSON.parse(fs.readFileSync('security-bandit.json', 'utf8'));
            if (banditReport.results && banditReport.results.length > 0) {
              securityIssues.push(`**Bandit Issues:** ${banditReport.results.length} security issues found`);
            }
          } catch (e) {}
          
          try {
            const npmAudit = JSON.parse(fs.readFileSync('security-npm.json', 'utf8'));
            if (npmAudit.vulnerabilities && Object.keys(npmAudit.vulnerabilities).length > 0) {
              securityIssues.push(`**NPM Audit Issues:** ${Object.keys(npmAudit.vulnerabilities).length} vulnerabilities found`);
            }
          } catch (e) {}
          
          if (securityIssues.length > 0) {
            const body = `## Security Audit Report\n\n${securityIssues.join('\n')}\n\nPlease review and address these security issues.`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Security Audit Report - ' + new Date().toISOString().split('T')[0],
              body: body,
              labels: ['security', 'maintenance', 'high-priority']
            });
          }

  performance-monitoring:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        pip install django-extensions memory-profiler
    
    - name: Run performance tests
      run: |
        cd backend
        pip install -r requirements.txt
        python manage.py test tests.test_simple
        
    - name: Generate performance report
      run: |
        echo "Performance monitoring completed" > performance-report.txt
        echo "Test execution time: $(date)" >> performance-report.txt

  code-metrics:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install code analysis tools
      run: |
        pip install radon flake8 mypy
    
    - name: Run code complexity analysis
      run: |
        cd backend
        radon cc . --json > ../complexity-report.json
        radon mi . --json > ../maintainability-report.json
        flake8 . --statistics --tee --output-file=../flake8-report.txt || true
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install frontend analysis tools
      run: |
        cd frontend
        npm install -g typescript-analyzer
    
    - name: Create code metrics report
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          let metricsReport = '## Code Metrics Report\n\n';
          
          try {
            const complexity = JSON.parse(fs.readFileSync('complexity-report.json', 'utf8'));
            metricsReport += '### Complexity Analysis\n';
            metricsReport += `- Files analyzed: ${Object.keys(complexity).length}\n`;
          } catch (e) {}
          
          try {
            const flake8 = fs.readFileSync('flake8-report.txt', 'utf8');
            if (flake8.trim()) {
              metricsReport += '\n### Code Style Issues\n```\n' + flake8 + '\n```\n';
            }
          } catch (e) {}
          
          if (metricsReport.length > 50) {
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Code Metrics Report - ' + new Date().toISOString().split('T')[0],
              body: metricsReport,
              labels: ['maintenance', 'code-quality']
            });
          }